-- Copyright 2023 Google LLC
--
-- Licensed under the Apache License, Version 2.0 (the "License");
-- you may not use this file except in compliance with the License.
-- You may obtain a copy of the License at
--
--     http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing, software
-- distributed under the License is distributed on an "AS IS" BASIS,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-- See the License for the specific language governing permissions and
-- limitations under the License.

DECLARE max_date DATE;
DECLARE min_date DATE;

SET max_date = (SELECT DATE_SUB(MAX(event_date), INTERVAL 15 DAY) FROM `{{mds_project_id}}.{{mds_dataset}}.event`); 
SET min_date = (SELECT DATE_ADD(MIN(event_date), INTERVAL 30 DAY) FROM `{{mds_project_id}}.{{mds_dataset}}.event`); 

CREATE OR REPLACE TEMP TABLE training_preparation_ud as (
  SELECT DISTINCT
    UD.user_pseudo_id,
    MAX(UD.user_id) OVER(user_dimensions_window) AS user_id,
    UD.feature_date,
    MAX(UD.month_of_the_year) OVER(user_dimensions_window) AS month_of_the_year,
    MAX(UD.week_of_the_year) OVER(user_dimensions_window) AS week_of_the_year,
    MAX(UD.day_of_the_month) OVER(user_dimensions_window) AS day_of_the_month,
    MAX(UD.day_of_week) OVER(user_dimensions_window) AS day_of_week,
    MAX(UD.user_ltv_revenue) OVER(user_dimensions_window) AS user_ltv_revenue,
    MAX(UD.device_category) OVER(user_dimensions_window) AS device_category,
    MAX(UD.device_mobile_brand_name) OVER(user_dimensions_window) AS device_mobile_brand_name,
    MAX(UD.device_mobile_model_name) OVER(user_dimensions_window) AS device_mobile_model_name,
    MAX(UD.device_os) OVER(user_dimensions_window) AS device_os,
    MAX(UD.device_os_version) OVER(user_dimensions_window) AS device_os_version,
    MAX(UD.device_language) OVER(user_dimensions_window) AS device_language,
    MAX(UD.device_web_browser) OVER(user_dimensions_window) AS device_web_browser,
    MAX(UD.device_web_browser_version) OVER(user_dimensions_window) AS device_web_browser_version,
    MAX(UD.geo_sub_continent) OVER(user_dimensions_window) AS geo_sub_continent,
    MAX(UD.geo_country) OVER(user_dimensions_window) AS geo_country,
    MAX(UD.geo_region) OVER(user_dimensions_window) AS geo_region,
    MAX(UD.geo_city) OVER(user_dimensions_window) AS geo_city,
    MAX(UD.geo_metro) OVER(user_dimensions_window) AS geo_metro,
    MAX(UD.last_traffic_source_medium) OVER(user_dimensions_window) AS last_traffic_source_medium,
    MAX(UD.last_traffic_source_name) OVER(user_dimensions_window) AS last_traffic_source_name,
    MAX(UD.last_traffic_source_source) OVER(user_dimensions_window) AS last_traffic_source_source,
    MAX(UD.first_traffic_source_medium) OVER(user_dimensions_window) AS first_traffic_source_medium,
    MAX(UD.first_traffic_source_name) OVER(user_dimensions_window) AS first_traffic_source_name,
    MAX(UD.first_traffic_source_source) OVER(user_dimensions_window) AS first_traffic_source_source,
    MAX(UD.has_signed_in_with_user_id) OVER(user_dimensions_window) AS has_signed_in_with_user_id,
FROM
  `{{feature_store_project_id}}.{{feature_store_dataset}}.user_dimensions` UD
WHERE
  -- In the future consider `feature_date BETWEEN start_date AND end_date`, to process multiple days. Modify Partition BY
  UD.feature_date BETWEEN GREATEST(start_date, min_date) AND LEAST(end_date, max_date)
WINDOW 
  user_dimensions_window AS (PARTITION BY UD.user_pseudo_id, UD.feature_date ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
);

CREATE OR REPLACE TEMP TABLE training_preparation_useam as (
  SELECT DISTINCT
    USEAM.user_pseudo_id,
    USEAM.feature_date,
    MAX(USEAM.engagement_rate) OVER(user_session_event_aggregated_metrics_window) AS engagement_rate,
    MAX(USEAM.engaged_sessions_per_user) OVER(user_session_event_aggregated_metrics_window) AS engaged_sessions_per_user,
    MAX(USEAM.session_conversion_rate) OVER(user_session_event_aggregated_metrics_window) AS session_conversion_rate,
    MAX(USEAM.bounces) OVER(user_session_event_aggregated_metrics_window) AS bounces,
    MAX(USEAM.bounce_rate_per_user) OVER(user_session_event_aggregated_metrics_window) AS bounce_rate_per_user,
    MAX(USEAM.sessions_per_user) OVER(user_session_event_aggregated_metrics_window) AS sessions_per_user,
    MAX(USEAM.avg_views_per_session) OVER(user_session_event_aggregated_metrics_window) AS avg_views_per_session,
    MAX(USEAM.sum_engagement_time_seconds) OVER(user_session_event_aggregated_metrics_window) AS sum_engagement_time_seconds,
    MAX(USEAM.avg_engagement_time_seconds) OVER(user_session_event_aggregated_metrics_window) AS avg_engagement_time_seconds,
    MAX(USEAM.new_visits) OVER(user_session_event_aggregated_metrics_window) AS new_visits,
    MAX(USEAM.returning_visits) OVER(user_session_event_aggregated_metrics_window) AS returning_visits,
    MAX(USEAM.add_to_carts) OVER(user_session_event_aggregated_metrics_window) AS add_to_carts,
    MAX(USEAM.cart_to_view_rate) OVER(user_session_event_aggregated_metrics_window) AS cart_to_view_rate,
    MAX(USEAM.checkouts) OVER(user_session_event_aggregated_metrics_window) AS checkouts,
    MAX(USEAM.ecommerce_purchases) OVER(user_session_event_aggregated_metrics_window) AS ecommerce_purchases,
    MAX(USEAM.ecommerce_quantity) OVER(user_session_event_aggregated_metrics_window) AS ecommerce_quantity,
    MAX(USEAM.ecommerce_revenue) OVER(user_session_event_aggregated_metrics_window) AS ecommerce_revenue,
    MAX(USEAM.item_revenue) OVER(user_session_event_aggregated_metrics_window) AS item_revenue,
    MAX(USEAM.item_quantity) OVER(user_session_event_aggregated_metrics_window) AS item_quantity,
    MAX(USEAM.item_view_events) OVER(user_session_event_aggregated_metrics_window) AS item_view_events,
    MAX(USEAM.items_clicked_in_promotion) OVER(user_session_event_aggregated_metrics_window) AS items_clicked_in_promotion,
    MAX(USEAM.items_clicked_in_list) OVER(user_session_event_aggregated_metrics_window) AS items_clicked_in_list,
    MAX(USEAM.items_checked_out) OVER(user_session_event_aggregated_metrics_window) AS items_checked_out,
    MAX(USEAM.items_added_to_cart) OVER(user_session_event_aggregated_metrics_window) AS items_added_to_cart,
    MAX(USEAM.item_list_view_events) OVER(user_session_event_aggregated_metrics_window) AS item_list_view_events,
    MAX(USEAM.purchase_revenue) OVER(user_session_event_aggregated_metrics_window) AS purchase_revenue,
    MAX(USEAM.purchase_to_view_rate) OVER(user_session_event_aggregated_metrics_window) AS purchase_to_view_rate,
    MAX(USEAM.transactions_per_purchaser) OVER(user_session_event_aggregated_metrics_window) AS transactions_per_purchaser,
    MAX(USEAM.user_conversion_rate) OVER(user_session_event_aggregated_metrics_window) AS user_conversion_rate,
    MAX(USEAM.how_many_purchased_before) OVER(user_session_event_aggregated_metrics_window) AS how_many_purchased_before,
    MAX(USEAM.has_abandoned_cart) OVER(user_session_event_aggregated_metrics_window) AS has_abandoned_cart
FROM
  `{{feature_store_project_id}}.{{feature_store_dataset}}.user_session_event_aggregated_metrics` USEAM
WHERE
  -- In the future consider `feature_date BETWEEN start_date AND end_date`, to process multiple days. Modify Partition BY
  USEAM.feature_date BETWEEN GREATEST(start_date, min_date) AND LEAST(end_date, max_date)
WINDOW 
  user_session_event_aggregated_metrics_window AS (PARTITION BY USEAM.user_pseudo_id, USEAM.feature_date ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
);

CREATE OR REPLACE TEMP TABLE training_preparation_uwm as (
  SELECT DISTINCT
    UWM.user_pseudo_id,
    UWM.feature_date,
    MAX(UWM.active_users_past_1_day) OVER(user_rolling_window) AS active_users_past_1_day,
    MAX(UWM.active_users_past_2_day) OVER(user_rolling_window) AS active_users_past_2_day,
    MAX(UWM.active_users_past_3_day) OVER(user_rolling_window) AS active_users_past_3_day,
    MAX(UWM.active_users_past_4_day) OVER(user_rolling_window) AS active_users_past_4_day,
    MAX(UWM.active_users_past_5_day) OVER(user_rolling_window) AS active_users_past_5_day,
    MAX(UWM.active_users_past_6_day) OVER(user_rolling_window) AS active_users_past_6_day,
    MAX(UWM.active_users_past_7_day) OVER(user_rolling_window) AS active_users_past_7_day,
    MAX(UWM.active_users_past_8_14_day) OVER(user_rolling_window) AS active_users_past_8_14_day,
    MAX(UWM.active_users_past_15_30_day) OVER(user_rolling_window) AS active_users_past_15_30_day,
    MAX(UWM.purchases_past_1_day) OVER(user_rolling_window) AS purchases_past_1_day,
    MAX(UWM.purchases_past_2_day) OVER(user_rolling_window) AS purchases_past_2_day,
    MAX(UWM.purchases_past_3_day) OVER(user_rolling_window) AS purchases_past_3_day,
    MAX(UWM.purchases_past_4_day) OVER(user_rolling_window) AS purchases_past_4_day,
    MAX(UWM.purchases_past_5_day) OVER(user_rolling_window) AS purchases_past_5_day,
    MAX(UWM.purchases_past_6_day) OVER(user_rolling_window) AS purchases_past_6_day,
    MAX(UWM.purchases_past_7_day) OVER(user_rolling_window) AS purchases_past_7_day,
    MAX(UWM.purchases_past_8_14_day) OVER(user_rolling_window) AS purchases_past_8_14_day,
    MAX(UWM.purchases_past_15_30_day) OVER(user_rolling_window) AS purchases_past_15_30_day,
    MAX(UWM.visits_past_1_day) OVER(user_rolling_window) AS visits_past_1_day,
    MAX(UWM.visits_past_2_day) OVER(user_rolling_window) AS visits_past_2_day,
    MAX(UWM.visits_past_3_day) OVER(user_rolling_window) AS visits_past_3_day,
    MAX(UWM.visits_past_4_day) OVER(user_rolling_window) AS visits_past_4_day,
    MAX(UWM.visits_past_5_day) OVER(user_rolling_window) AS visits_past_5_day,
    MAX(UWM.visits_past_6_day) OVER(user_rolling_window) AS visits_past_6_day,
    MAX(UWM.visits_past_7_day) OVER(user_rolling_window) AS visits_past_7_day,
    MAX(UWM.visits_past_8_14_day) OVER(user_rolling_window) AS visits_past_8_14_day,
    MAX(UWM.visits_past_15_30_day) OVER(user_rolling_window) AS visits_past_15_30_day,
    MAX(UWM.view_items_past_1_day) OVER(user_rolling_window) AS view_items_past_1_day,
    MAX(UWM.view_items_past_2_day) OVER(user_rolling_window) AS view_items_past_2_day,
    MAX(UWM.view_items_past_3_day) OVER(user_rolling_window) AS view_items_past_3_day,
    MAX(UWM.view_items_past_4_day) OVER(user_rolling_window) AS view_items_past_4_day,
    MAX(UWM.view_items_past_5_day) OVER(user_rolling_window) AS view_items_past_5_day,
    MAX(UWM.view_items_past_6_day) OVER(user_rolling_window) AS view_items_past_6_day,
    MAX(UWM.view_items_past_7_day) OVER(user_rolling_window) AS view_items_past_7_day,
    MAX(UWM.view_items_past_8_14_day) OVER(user_rolling_window) AS view_items_past_8_14_day,
    MAX(UWM.view_items_past_15_30_day) OVER(user_rolling_window) AS view_items_past_15_30_day,
    MAX(UWM.add_to_carts_past_1_day) OVER(user_rolling_window) AS add_to_carts_past_1_day,
    MAX(UWM.add_to_carts_past_2_day) OVER(user_rolling_window) AS add_to_carts_past_2_day,
    MAX(UWM.add_to_carts_past_3_day) OVER(user_rolling_window) AS add_to_carts_past_3_day,
    MAX(UWM.add_to_carts_past_4_day) OVER(user_rolling_window) AS add_to_carts_past_4_day,
    MAX(UWM.add_to_carts_past_5_day) OVER(user_rolling_window) AS add_to_carts_past_5_day,
    MAX(UWM.add_to_carts_past_6_day) OVER(user_rolling_window) AS add_to_carts_past_6_day,
    MAX(UWM.add_to_carts_past_7_day) OVER(user_rolling_window) AS add_to_carts_past_7_day,
    MAX(UWM.add_to_carts_past_8_14_day) OVER(user_rolling_window) AS add_to_carts_past_8_14_day,
    MAX(UWM.add_to_carts_past_15_30_day) OVER(user_rolling_window) AS add_to_carts_past_15_30_day,
    MAX(UWM.checkouts_past_1_day) OVER(user_rolling_window) AS checkouts_past_1_day,
    MAX(UWM.checkouts_past_2_day) OVER(user_rolling_window) AS checkouts_past_2_day,
    MAX(UWM.checkouts_past_3_day) OVER(user_rolling_window) AS checkouts_past_3_day,
    MAX(UWM.checkouts_past_4_day) OVER(user_rolling_window) AS checkouts_past_4_day,
    MAX(UWM.checkouts_past_5_day) OVER(user_rolling_window) AS checkouts_past_5_day,
    MAX(UWM.checkouts_past_6_day) OVER(user_rolling_window) AS checkouts_past_6_day,
    MAX(UWM.checkouts_past_7_day) OVER(user_rolling_window) AS checkouts_past_7_day,
    MAX(UWM.checkouts_past_8_14_day) OVER(user_rolling_window) AS checkouts_past_8_14_day,
    MAX(UWM.checkouts_past_15_30_day) OVER(user_rolling_window) AS checkouts_past_15_30_day,
FROM
  `{{feature_store_project_id}}.{{feature_store_dataset}}.user_rolling_window_metrics` UWM
WHERE
  -- In the future consider `feature_date BETWEEN start_date AND end_date`, to process multiple days. Modify Partition BY
  UWM.feature_date BETWEEN GREATEST(start_date, min_date) AND LEAST(end_date, max_date)
WINDOW 
  user_rolling_window AS (PARTITION BY UWM.user_pseudo_id, UWM.feature_date ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
);

CREATE OR REPLACE TEMP TABLE training_preparation_um as (
  SELECT DISTINCT
    UM.feature_date,
    MAX(UM.purchasers_users) OVER(user_scoped_metrics_window) AS purchasers_users,
    MAX(UM.average_daily_purchasers) OVER(user_scoped_metrics_window) AS average_daily_purchasers,
    MAX(UM.active_users) OVER(user_scoped_metrics_window) AS active_users,
    MAX(UM.DAU) OVER(user_scoped_metrics_window) AS DAU,
    MAX(UM.MAU) OVER(user_scoped_metrics_window) AS MAU,
    MAX(UM.WAU) OVER(user_scoped_metrics_window) AS WAU,
    MAX(UM.dau_per_mau) OVER(user_scoped_metrics_window) AS dau_per_mau,
    MAX(UM.dau_per_wau) OVER(user_scoped_metrics_window) AS dau_per_wau,
    MAX(UM.wau_per_mau) OVER(user_scoped_metrics_window) AS wau_per_mau,
    MAX(UM.users_engagement_duration_seconds) OVER(user_scoped_metrics_window) AS users_engagement_duration_seconds,
    MAX(UM.average_engagement_time) OVER(user_scoped_metrics_window) AS average_engagement_time,
    MAX(UM.average_engagement_time_per_session) OVER(user_scoped_metrics_window) AS average_engagement_time_per_session,
    MAX(UM.average_sessions_per_user) OVER(user_scoped_metrics_window) AS average_sessions_per_user,
    MAX(UM.ARPPU) OVER(user_scoped_metrics_window) AS ARPPU,
    MAX(UM.ARPU) OVER(user_scoped_metrics_window) AS ARPU,
    MAX(UM.average_daily_revenue) OVER(user_scoped_metrics_window) AS average_daily_revenue,
    MAX(UM.max_daily_revenue) OVER(user_scoped_metrics_window) AS max_daily_revenue,
    MAX(UM.min_daily_revenue) OVER(user_scoped_metrics_window) AS min_daily_revenue,
    MAX(UM.new_users) OVER(user_scoped_metrics_window) AS new_users,
    MAX(UM.returning_users) OVER(user_scoped_metrics_window) AS returning_users,
    MAX(UM.first_time_purchasers) OVER(user_scoped_metrics_window) AS first_time_purchasers,
    MAX(UM.first_time_purchaser_conversion) OVER(user_scoped_metrics_window) AS first_time_purchaser_conversion,
    MAX(UM.first_time_purchasers_per_new_user) OVER(user_scoped_metrics_window) AS first_time_purchasers_per_new_user,
    MAX(UM.avg_user_conversion_rate) OVER(user_scoped_metrics_window) AS avg_user_conversion_rate,
    MAX(UM.avg_session_conversion_rate) OVER(user_scoped_metrics_window) AS avg_session_conversion_rate
FROM
  `{{feature_store_project_id}}.{{feature_store_dataset}}.user_scoped_metrics` UM
WHERE
  -- In the future consider `feature_date BETWEEN start_date AND end_date`, to process multiple days.
  UM.feature_date BETWEEN GREATEST(start_date, min_date) AND LEAST(end_date, max_date)
WINDOW 
  user_scoped_metrics_window AS (PARTITION BY UM.feature_date ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
);

CREATE OR REPLACE TEMP TABLE training_preparation_label as (
  SELECT DISTINCT
  LABEL.user_pseudo_id,
  LABEL.feature_date,
  MAX(LABEL.purchase_day_1) OVER(purchase_propensity_label_window) AS purchase_day_1,
  MAX(LABEL.purchase_day_2) OVER(purchase_propensity_label_window) AS purchase_day_2,
  MAX(LABEL.purchase_day_3) OVER(purchase_propensity_label_window) AS purchase_day_3,
  MAX(LABEL.purchase_day_4) OVER(purchase_propensity_label_window) AS purchase_day_4,
  MAX(LABEL.purchase_day_5) OVER(purchase_propensity_label_window) AS purchase_day_5,
  MAX(LABEL.purchase_day_6) OVER(purchase_propensity_label_window) AS purchase_day_6,
  MAX(LABEL.purchase_day_7) OVER(purchase_propensity_label_window) AS purchase_day_7,
  MAX(LABEL.purchase_day_8) OVER(purchase_propensity_label_window) AS purchase_day_8,
  MAX(LABEL.purchase_day_9) OVER(purchase_propensity_label_window) AS purchase_day_9,
  MAX(LABEL.purchase_day_10) OVER(purchase_propensity_label_window) AS purchase_day_10,
  MAX(LABEL.purchase_day_11) OVER(purchase_propensity_label_window) AS purchase_day_11,
  MAX(LABEL.purchase_day_12) OVER(purchase_propensity_label_window) AS purchase_day_12,
  MAX(LABEL.purchase_day_13) OVER(purchase_propensity_label_window) AS purchase_day_13,
  MAX(LABEL.purchase_day_14) OVER(purchase_propensity_label_window) AS purchase_day_14,
  MAX(LABEL.purchase_day_15_30) OVER(purchase_propensity_label_window) AS purchase_day_15_30
FROM
  `{{feature_store_project_id}}.{{feature_store_dataset}}.purchase_propensity_label` LABEL
WHERE
  -- Define the training subset interval
  LABEL.feature_date BETWEEN GREATEST(start_date, min_date) AND LEAST(end_date, max_date)
WINDOW 
  purchase_propensity_label_window AS (PARTITION BY LABEL.user_pseudo_id, LABEL.feature_date ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
);

CREATE OR REPLACE TEMP TABLE training_preparation as (
  SELECT DISTINCT
    UD.user_pseudo_id,
    UD.user_id,
    UD.feature_date,
    UD.month_of_the_year,
    UD.week_of_the_year,
    UD.day_of_the_month,
    UD.day_of_week,
    UD.user_ltv_revenue,
    UD.device_category,
    UD.device_mobile_brand_name,
    UD.device_mobile_model_name,
    UD.device_os,
    UD.device_os_version,
    UD.device_language,
    UD.device_web_browser,
    UD.device_web_browser_version,
    UD.geo_sub_continent,
    UD.geo_country,
    UD.geo_region,
    UD.geo_city,
    UD.geo_metro,
    UD.last_traffic_source_medium,
    UD.last_traffic_source_name,
    UD.last_traffic_source_source,
    UD.first_traffic_source_medium,
    UD.first_traffic_source_name,
    UD.first_traffic_source_source,
    UD.has_signed_in_with_user_id,
    USEAM.engagement_rate,
    USEAM.engaged_sessions_per_user,
    USEAM.session_conversion_rate,
    USEAM.bounces,
    USEAM.bounce_rate_per_user,
    USEAM.sessions_per_user,
    USEAM.avg_views_per_session,
    USEAM.sum_engagement_time_seconds,
    USEAM.avg_engagement_time_seconds,
    USEAM.new_visits,
    USEAM.returning_visits,
    USEAM.add_to_carts,
    USEAM.cart_to_view_rate,
    USEAM.checkouts,
    USEAM.ecommerce_purchases,
    USEAM.ecommerce_quantity,
    USEAM.ecommerce_revenue,
    USEAM.item_revenue,
    USEAM.item_quantity,
    USEAM.item_view_events,
    USEAM.items_clicked_in_promotion,
    USEAM.items_clicked_in_list,
    USEAM.items_checked_out,
    USEAM.items_added_to_cart,
    USEAM.item_list_view_events,
    USEAM.purchase_revenue,
    USEAM.purchase_to_view_rate,
    USEAM.transactions_per_purchaser,
    USEAM.user_conversion_rate,
    USEAM.how_many_purchased_before,
    USEAM.has_abandoned_cart,
    UWM.active_users_past_1_day,
    UWM.active_users_past_2_day,
    UWM.active_users_past_3_day,
    UWM.active_users_past_4_day,
    UWM.active_users_past_5_day,
    UWM.active_users_past_6_day,
    UWM.active_users_past_7_day,
    UWM.active_users_past_8_14_day,
    UWM.active_users_past_15_30_day,
    UWM.purchases_past_1_day,
    UWM.purchases_past_2_day,
    UWM.purchases_past_3_day,
    UWM.purchases_past_4_day,
    UWM.purchases_past_5_day,
    UWM.purchases_past_6_day,
    UWM.purchases_past_7_day,
    UWM.purchases_past_8_14_day,
    UWM.purchases_past_15_30_day,
    UWM.visits_past_1_day,
    UWM.visits_past_2_day,
    UWM.visits_past_3_day,
    UWM.visits_past_4_day,
    UWM.visits_past_5_day,
    UWM.visits_past_6_day,
    UWM.visits_past_7_day,
    UWM.visits_past_8_14_day,
    UWM.visits_past_15_30_day,
    UWM.view_items_past_1_day,
    UWM.view_items_past_2_day,
    UWM.view_items_past_3_day,
    UWM.view_items_past_4_day,
    UWM.view_items_past_5_day,
    UWM.view_items_past_6_day,
    UWM.view_items_past_7_day,
    UWM.view_items_past_8_14_day,
    UWM.view_items_past_15_30_day,
    UWM.add_to_carts_past_1_day,
    UWM.add_to_carts_past_2_day,
    UWM.add_to_carts_past_3_day,
    UWM.add_to_carts_past_4_day,
    UWM.add_to_carts_past_5_day,
    UWM.add_to_carts_past_6_day,
    UWM.add_to_carts_past_7_day,
    UWM.add_to_carts_past_8_14_day,
    UWM.add_to_carts_past_15_30_day,
    UWM.checkouts_past_1_day,
    UWM.checkouts_past_2_day,
    UWM.checkouts_past_3_day,
    UWM.checkouts_past_4_day,
    UWM.checkouts_past_5_day,
    UWM.checkouts_past_6_day,
    UWM.checkouts_past_7_day,
    UWM.checkouts_past_8_14_day,
    UWM.checkouts_past_15_30_day,
    UM.purchasers_users,
    UM.average_daily_purchasers,
    UM.active_users,
    UM.DAU,
    UM.MAU,
    UM.WAU,
    UM.dau_per_mau,
    UM.dau_per_wau,
    UM.wau_per_mau,
    UM.users_engagement_duration_seconds,
    UM.average_engagement_time,
    UM.average_engagement_time_per_session,
    UM.average_sessions_per_user,
    UM.ARPPU,
    UM.ARPU,
    UM.average_daily_revenue,
    UM.max_daily_revenue,
    UM.min_daily_revenue,
    UM.new_users,
    UM.returning_users,
    UM.first_time_purchasers,
    UM.first_time_purchaser_conversion,
    UM.first_time_purchasers_per_new_user,
    UM.avg_user_conversion_rate,
    UM.avg_session_conversion_rate,
    LABEL.purchase_day_1,
    LABEL.purchase_day_2,
    LABEL.purchase_day_3,
    LABEL.purchase_day_4,
    LABEL.purchase_day_5,
    LABEL.purchase_day_6,
    LABEL.purchase_day_7,
    LABEL.purchase_day_8,
    LABEL.purchase_day_9,
    LABEL.purchase_day_10,
    LABEL.purchase_day_11,
    LABEL.purchase_day_12,
    LABEL.purchase_day_13,
    LABEL.purchase_day_14,
    LABEL.purchase_day_15_30
FROM
  training_preparation_ud UD
INNER JOIN
  training_preparation_useam USEAM
ON
  USEAM.user_pseudo_id = UD.user_pseudo_id
  AND USEAM.feature_date = UD.feature_date
INNER JOIN
  training_preparation_uwm UWM
ON
  UWM.user_pseudo_id = UD.user_pseudo_id
  AND UWM.feature_date = UD.feature_date
INNER JOIN
  training_preparation_um UM
ON
  UM.feature_date = UD.feature_date
INNER JOIN
  training_preparation_label LABEL
ON
  LABEL.user_pseudo_id = UD.user_pseudo_id
  AND LABEL.feature_date = UD.feature_date
);

CREATE OR REPLACE TEMP TABLE DataForTargetTable AS(
  SELECT DISTINCT
  CASE 
    WHEN (ABS(MOD(FARM_FINGERPRINT(user_pseudo_id), 10)) BETWEEN 0 AND train_split_end_number) THEN "TRAIN" 
    WHEN (ABS(MOD(FARM_FINGERPRINT(user_pseudo_id), 10)) BETWEEN train_split_end_number AND validation_split_end_number) THEN "VALIDATE" 
    WHEN (ABS(MOD(FARM_FINGERPRINT(user_pseudo_id), 10)) BETWEEN validation_split_end_number AND 9) THEN "TEST"
  END as data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  engagement_rate,
  engaged_sessions_per_user,
  session_conversion_rate,
  bounces,
  bounce_rate_per_user,
  sessions_per_user,
  avg_views_per_session,
  sum_engagement_time_seconds,
  avg_engagement_time_seconds,
  new_visits,
  returning_visits,
  add_to_carts,
  cart_to_view_rate,
  checkouts,
  ecommerce_purchases,
  ecommerce_quantity,
  ecommerce_revenue,
  item_revenue,
  item_quantity,
  item_view_events,
  items_clicked_in_promotion,
  items_clicked_in_list,
  items_checked_out,
  items_added_to_cart,
  item_list_view_events,
  purchase_revenue,
  purchase_to_view_rate,
  transactions_per_purchaser,
  user_conversion_rate,
  how_many_purchased_before,
  has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  purchasers_users,
  average_daily_purchasers,
  active_users,
  DAU,
  MAU,
  WAU,
  dau_per_mau,
  dau_per_wau,
  wau_per_mau,
  users_engagement_duration_seconds,
  average_engagement_time,
  average_engagement_time_per_session,
  average_sessions_per_user,
  ARPPU,
  ARPU,
  average_daily_revenue,
  max_daily_revenue,
  min_daily_revenue,
  new_users,
  returning_users,
  first_time_purchasers,
  first_time_purchaser_conversion,
  first_time_purchasers_per_new_user,
  avg_user_conversion_rate,
  avg_session_conversion_rate,
  purchase_day_1,
  purchase_day_2,
  purchase_day_3,
  purchase_day_4,
  purchase_day_5,
  purchase_day_6,
  purchase_day_7,
  purchase_day_8,
  purchase_day_9,
  purchase_day_10,
  purchase_day_11,
  purchase_day_12,
  purchase_day_13,
  purchase_day_14,
  purchase_day_15_30
  FROM training_preparation);

CREATE OR REPLACE TABLE `{{project_id}}.{{dataset}}.purchase_propensity_training_full_dataset` AS
SELECT DISTINCT * FROM DataForTargetTable
WHERE data_split IS NOT NULL;


CREATE OR REPLACE TABLE `{{project_id}}.{{dataset}}.purchase_propensity_training_30_30` AS(
  SELECT DISTINCT
  CURRENT_TIMESTAMP() AS processed_timestamp, 
  data_split,
  feature_date,
  user_pseudo_id,
  LAST_VALUE(user_id) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  LAST_VALUE(user_ltv_revenue) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS user_ltv_revenue,
  LAST_VALUE(device_category) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_category,
  LAST_VALUE(device_mobile_brand_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_mobile_brand_name,
  LAST_VALUE(device_mobile_model_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_mobile_model_name,
  LAST_VALUE(device_os) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_os,
  LAST_VALUE(device_os_version) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_os_version,
  LAST_VALUE(device_language) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_language,
  LAST_VALUE(device_web_browser) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_web_browser,
  LAST_VALUE(device_web_browser_version) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_web_browser_version,
  LAST_VALUE(geo_sub_continent) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_sub_continent,
  LAST_VALUE(geo_country) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_country,
  LAST_VALUE(geo_region) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_region,
  LAST_VALUE(geo_city) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_city,
  LAST_VALUE(geo_metro) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_metro,
  LAST_VALUE(last_traffic_source_medium) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_medium,
  LAST_VALUE(last_traffic_source_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_name,
  LAST_VALUE(last_traffic_source_source) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_source,
  LAST_VALUE(first_traffic_source_medium) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_medium,
  LAST_VALUE(first_traffic_source_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_name,
  LAST_VALUE(first_traffic_source_source) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_source,
  LAST_VALUE(has_signed_in_with_user_id) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  LAST_VALUE(active_users_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_1_day,
  LAST_VALUE(active_users_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_2_day,
  LAST_VALUE(active_users_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_3_day,
  LAST_VALUE(active_users_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_4_day,
  LAST_VALUE(active_users_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_5_day,
  LAST_VALUE(active_users_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_6_day,
  LAST_VALUE(active_users_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_7_day,
  LAST_VALUE(active_users_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_8_14_day,
  LAST_VALUE(active_users_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_15_30_day,
  LAST_VALUE(purchases_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_1_day,
  LAST_VALUE(purchases_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_2_day,
  LAST_VALUE(purchases_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_3_day,
  LAST_VALUE(purchases_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_4_day,
  LAST_VALUE(purchases_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_5_day,
  LAST_VALUE(purchases_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_6_day,
  LAST_VALUE(purchases_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_7_day,
  LAST_VALUE(purchases_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_8_14_day,
  LAST_VALUE(purchases_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_15_30_day,
  LAST_VALUE(visits_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_1_day,
  LAST_VALUE(visits_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_2_day,
  LAST_VALUE(visits_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_3_day,
  LAST_VALUE(visits_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_4_day,
  LAST_VALUE(visits_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_5_day,
  LAST_VALUE(visits_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_6_day,
  LAST_VALUE(visits_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_7_day,
  LAST_VALUE(visits_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_8_14_day,
  LAST_VALUE(visits_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_15_30_day,
  LAST_VALUE(view_items_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_1_day,
  LAST_VALUE(view_items_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_2_day,
  LAST_VALUE(view_items_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_3_day,
  LAST_VALUE(view_items_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_4_day,
  LAST_VALUE(view_items_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_5_day,
  LAST_VALUE(view_items_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_6_day,
  LAST_VALUE(view_items_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_7_day,
  LAST_VALUE(view_items_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_8_14_day,
  LAST_VALUE(view_items_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_15_30_day,
  LAST_VALUE(add_to_carts_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_1_day,
  LAST_VALUE(add_to_carts_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_2_day,
  LAST_VALUE(add_to_carts_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_3_day,
  LAST_VALUE(add_to_carts_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_4_day,
  LAST_VALUE(add_to_carts_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_5_day,
  LAST_VALUE(add_to_carts_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_6_day,
  LAST_VALUE(add_to_carts_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_7_day,
  LAST_VALUE(add_to_carts_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_8_14_day,
  LAST_VALUE(add_to_carts_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_15_30_day,
  LAST_VALUE(checkouts_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_1_day,
  LAST_VALUE(checkouts_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_2_day,
  LAST_VALUE(checkouts_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_3_day,
  LAST_VALUE(checkouts_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_4_day,
  LAST_VALUE(checkouts_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_5_day,
  LAST_VALUE(checkouts_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_6_day,
  LAST_VALUE(checkouts_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_7_day,
  LAST_VALUE(checkouts_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_8_14_day,
  LAST_VALUE(checkouts_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  LAST_VALUE(CASE WHEN (
  purchase_day_1+
  purchase_day_2+
  purchase_day_3+
  purchase_day_4+
  purchase_day_5+
  purchase_day_6+
  purchase_day_7+
  purchase_day_8+
  purchase_day_9+
  purchase_day_10+
  purchase_day_11+
  purchase_day_12+
  purchase_day_13+
  purchase_day_14+
  purchase_day_15_30) = 0 THEN 0 ELSE 1 END) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) as will_purchase
  FROM `{{project_id}}.{{dataset}}.purchase_propensity_training_full_dataset`
);


CREATE OR REPLACE TABLE `{{project_id}}.{{dataset}}.purchase_propensity_training_30_15` AS(
  SELECT DISTINCT
  CURRENT_TIMESTAMP() AS processed_timestamp, 
  data_split,
  feature_date,
  user_pseudo_id,
  LAST_VALUE(user_id) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  LAST_VALUE(user_ltv_revenue) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS user_ltv_revenue,
  LAST_VALUE(device_category) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_category,
  LAST_VALUE(device_mobile_brand_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_mobile_brand_name,
  LAST_VALUE(device_mobile_model_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_mobile_model_name,
  LAST_VALUE(device_os) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_os,
  LAST_VALUE(device_os_version) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_os_version,
  LAST_VALUE(device_language) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_language,
  LAST_VALUE(device_web_browser) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_web_browser,
  LAST_VALUE(device_web_browser_version) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_web_browser_version,
  LAST_VALUE(geo_sub_continent) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_sub_continent,
  LAST_VALUE(geo_country) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_country,
  LAST_VALUE(geo_region) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_region,
  LAST_VALUE(geo_city) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_city,
  LAST_VALUE(geo_metro) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_metro,
  LAST_VALUE(last_traffic_source_medium) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_medium,
  LAST_VALUE(last_traffic_source_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_name,
  LAST_VALUE(last_traffic_source_source) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_source,
  LAST_VALUE(first_traffic_source_medium) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_medium,
  LAST_VALUE(first_traffic_source_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_name,
  LAST_VALUE(first_traffic_source_source) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_source,
  LAST_VALUE(has_signed_in_with_user_id) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  LAST_VALUE(active_users_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_1_day,
  LAST_VALUE(active_users_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_2_day,
  LAST_VALUE(active_users_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_3_day,
  LAST_VALUE(active_users_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_4_day,
  LAST_VALUE(active_users_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_5_day,
  LAST_VALUE(active_users_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_6_day,
  LAST_VALUE(active_users_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_7_day,
  LAST_VALUE(active_users_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_8_14_day,
  LAST_VALUE(active_users_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_15_30_day,
  LAST_VALUE(purchases_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_1_day,
  LAST_VALUE(purchases_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_2_day,
  LAST_VALUE(purchases_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_3_day,
  LAST_VALUE(purchases_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_4_day,
  LAST_VALUE(purchases_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_5_day,
  LAST_VALUE(purchases_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_6_day,
  LAST_VALUE(purchases_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_7_day,
  LAST_VALUE(purchases_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_8_14_day,
  LAST_VALUE(purchases_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_15_30_day,
  LAST_VALUE(visits_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_1_day,
  LAST_VALUE(visits_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_2_day,
  LAST_VALUE(visits_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_3_day,
  LAST_VALUE(visits_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_4_day,
  LAST_VALUE(visits_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_5_day,
  LAST_VALUE(visits_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_6_day,
  LAST_VALUE(visits_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_7_day,
  LAST_VALUE(visits_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_8_14_day,
  LAST_VALUE(visits_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_15_30_day,
  LAST_VALUE(view_items_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_1_day,
  LAST_VALUE(view_items_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_2_day,
  LAST_VALUE(view_items_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_3_day,
  LAST_VALUE(view_items_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_4_day,
  LAST_VALUE(view_items_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_5_day,
  LAST_VALUE(view_items_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_6_day,
  LAST_VALUE(view_items_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_7_day,
  LAST_VALUE(view_items_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_8_14_day,
  LAST_VALUE(view_items_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_15_30_day,
  LAST_VALUE(add_to_carts_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_1_day,
  LAST_VALUE(add_to_carts_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_2_day,
  LAST_VALUE(add_to_carts_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_3_day,
  LAST_VALUE(add_to_carts_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_4_day,
  LAST_VALUE(add_to_carts_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_5_day,
  LAST_VALUE(add_to_carts_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_6_day,
  LAST_VALUE(add_to_carts_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_7_day,
  LAST_VALUE(add_to_carts_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_8_14_day,
  LAST_VALUE(add_to_carts_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_15_30_day,
  LAST_VALUE(checkouts_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_1_day,
  LAST_VALUE(checkouts_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_2_day,
  LAST_VALUE(checkouts_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_3_day,
  LAST_VALUE(checkouts_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_4_day,
  LAST_VALUE(checkouts_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_5_day,
  LAST_VALUE(checkouts_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_6_day,
  LAST_VALUE(checkouts_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_7_day,
  LAST_VALUE(checkouts_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_8_14_day,
  LAST_VALUE(checkouts_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  LAST_VALUE(CASE WHEN (
  purchase_day_1+
  purchase_day_2+
  purchase_day_3+
  purchase_day_4+
  purchase_day_5+
  purchase_day_6+
  purchase_day_7+
  purchase_day_8+
  purchase_day_9+
  purchase_day_10+
  purchase_day_11+
  purchase_day_12+
  purchase_day_13+
  purchase_day_14) = 0 THEN 0 ELSE 1 END) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) as will_purchase
  FROM `{{project_id}}.{{dataset}}.purchase_propensity_training_full_dataset`
);

CREATE OR REPLACE TABLE `{{project_id}}.{{dataset}}.purchase_propensity_training_15_15` AS(
  SELECT DISTINCT
  CURRENT_TIMESTAMP() AS processed_timestamp,
  data_split,
  feature_date,
  user_pseudo_id,
  LAST_VALUE(user_id) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  LAST_VALUE(user_ltv_revenue) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS user_ltv_revenue,
  LAST_VALUE(device_category) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_category,
  LAST_VALUE(device_mobile_brand_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_mobile_brand_name,
  LAST_VALUE(device_mobile_model_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_mobile_model_name,
  LAST_VALUE(device_os) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_os,
  LAST_VALUE(device_os_version) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_os_version,
  LAST_VALUE(device_language) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_language,
  LAST_VALUE(device_web_browser) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_web_browser,
  LAST_VALUE(device_web_browser_version) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_web_browser_version,
  LAST_VALUE(geo_sub_continent) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_sub_continent,
  LAST_VALUE(geo_country) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_country,
  LAST_VALUE(geo_region) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_region,
  LAST_VALUE(geo_city) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_city,
  LAST_VALUE(geo_metro) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_metro,
  LAST_VALUE(last_traffic_source_medium) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_medium,
  LAST_VALUE(last_traffic_source_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_name,
  LAST_VALUE(last_traffic_source_source) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_source,
  LAST_VALUE(first_traffic_source_medium) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_medium,
  LAST_VALUE(first_traffic_source_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_name,
  LAST_VALUE(first_traffic_source_source) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_source,
  LAST_VALUE(has_signed_in_with_user_id) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  LAST_VALUE(active_users_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_1_day,
  LAST_VALUE(active_users_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_2_day,
  LAST_VALUE(active_users_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_3_day,
  LAST_VALUE(active_users_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_4_day,
  LAST_VALUE(active_users_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_5_day,
  LAST_VALUE(active_users_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_6_day,
  LAST_VALUE(active_users_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_7_day,
  LAST_VALUE(active_users_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_8_14_day,
  --LAST_VALUE(active_users_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_15_30_day,
  LAST_VALUE(purchases_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_1_day,
  LAST_VALUE(purchases_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_2_day,
  LAST_VALUE(purchases_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_3_day,
  LAST_VALUE(purchases_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_4_day,
  LAST_VALUE(purchases_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_5_day,
  LAST_VALUE(purchases_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_6_day,
  LAST_VALUE(purchases_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_7_day,
  LAST_VALUE(purchases_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_8_14_day,
  --LAST_VALUE(purchases_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_15_30_day,
  LAST_VALUE(visits_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_1_day,
  LAST_VALUE(visits_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_2_day,
  LAST_VALUE(visits_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_3_day,
  LAST_VALUE(visits_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_4_day,
  LAST_VALUE(visits_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_5_day,
  LAST_VALUE(visits_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_6_day,
  LAST_VALUE(visits_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_7_day,
  LAST_VALUE(visits_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_8_14_day,
  --LAST_VALUE(visits_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_15_30_day,
  LAST_VALUE(view_items_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_1_day,
  LAST_VALUE(view_items_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_2_day,
  LAST_VALUE(view_items_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_3_day,
  LAST_VALUE(view_items_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_4_day,
  LAST_VALUE(view_items_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_5_day,
  LAST_VALUE(view_items_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_6_day,
  LAST_VALUE(view_items_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_7_day,
  LAST_VALUE(view_items_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_8_14_day,
  --LAST_VALUE(view_items_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_15_30_day,
  LAST_VALUE(add_to_carts_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_1_day,
  LAST_VALUE(add_to_carts_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_2_day,
  LAST_VALUE(add_to_carts_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_3_day,
  LAST_VALUE(add_to_carts_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_4_day,
  LAST_VALUE(add_to_carts_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_5_day,
  LAST_VALUE(add_to_carts_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_6_day,
  LAST_VALUE(add_to_carts_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_7_day,
  LAST_VALUE(add_to_carts_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_8_14_day,
  --LAST_VALUE(add_to_carts_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_15_30_day,
  LAST_VALUE(checkouts_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_1_day,
  LAST_VALUE(checkouts_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_2_day,
  LAST_VALUE(checkouts_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_3_day,
  LAST_VALUE(checkouts_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_4_day,
  LAST_VALUE(checkouts_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_5_day,
  LAST_VALUE(checkouts_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_6_day,
  LAST_VALUE(checkouts_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_7_day,
  LAST_VALUE(checkouts_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_8_14_day,
  --LAST_VALUE(checkouts_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  LAST_VALUE(CASE WHEN (
  purchase_day_1+
  purchase_day_2+
  purchase_day_3+
  purchase_day_4+
  purchase_day_5+
  purchase_day_6+
  purchase_day_7+
  purchase_day_8+
  purchase_day_9+
  purchase_day_10+
  purchase_day_11+
  purchase_day_12+
  purchase_day_13+
  purchase_day_14) = 0 THEN 0 ELSE 1 END) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) as will_purchase
  FROM `{{project_id}}.{{dataset}}.purchase_propensity_training_full_dataset`
);

CREATE OR REPLACE TABLE `{{project_id}}.{{dataset}}.purchase_propensity_training_15_7` AS(
  SELECT DISTINCT
  CURRENT_TIMESTAMP() AS processed_timestamp,
  data_split,
  feature_date,
  user_pseudo_id,
  LAST_VALUE(user_id) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  LAST_VALUE(user_ltv_revenue) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS user_ltv_revenue,
  LAST_VALUE(device_category) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_category,
  LAST_VALUE(device_mobile_brand_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_mobile_brand_name,
  LAST_VALUE(device_mobile_model_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_mobile_model_name,
  LAST_VALUE(device_os) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_os,
  LAST_VALUE(device_os_version) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_os_version,
  LAST_VALUE(device_language) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_language,
  LAST_VALUE(device_web_browser) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_web_browser,
  LAST_VALUE(device_web_browser_version) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS device_web_browser_version,
  LAST_VALUE(geo_sub_continent) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_sub_continent,
  LAST_VALUE(geo_country) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_country,
  LAST_VALUE(geo_region) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_region,
  LAST_VALUE(geo_city) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_city,
  LAST_VALUE(geo_metro) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS geo_metro,
  LAST_VALUE(last_traffic_source_medium) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_medium,
  LAST_VALUE(last_traffic_source_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_name,
  LAST_VALUE(last_traffic_source_source) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS last_traffic_source_source,
  LAST_VALUE(first_traffic_source_medium) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_medium,
  LAST_VALUE(first_traffic_source_name) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_name,
  LAST_VALUE(first_traffic_source_source) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS first_traffic_source_source,
  LAST_VALUE(has_signed_in_with_user_id) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  LAST_VALUE(active_users_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_1_day,
  LAST_VALUE(active_users_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_2_day,
  LAST_VALUE(active_users_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_3_day,
  LAST_VALUE(active_users_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_4_day,
  LAST_VALUE(active_users_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_5_day,
  LAST_VALUE(active_users_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_6_day,
  LAST_VALUE(active_users_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_7_day,
  LAST_VALUE(active_users_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_8_14_day,
  --LAST_VALUE(active_users_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS active_users_past_15_30_day,
  LAST_VALUE(purchases_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_1_day,
  LAST_VALUE(purchases_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_2_day,
  LAST_VALUE(purchases_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_3_day,
  LAST_VALUE(purchases_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_4_day,
  LAST_VALUE(purchases_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_5_day,
  LAST_VALUE(purchases_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_6_day,
  LAST_VALUE(purchases_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_7_day,
  LAST_VALUE(purchases_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_8_14_day,
  --LAST_VALUE(purchases_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS purchases_past_15_30_day,
  LAST_VALUE(visits_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_1_day,
  LAST_VALUE(visits_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_2_day,
  LAST_VALUE(visits_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_3_day,
  LAST_VALUE(visits_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_4_day,
  LAST_VALUE(visits_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_5_day,
  LAST_VALUE(visits_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_6_day,
  LAST_VALUE(visits_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_7_day,
  LAST_VALUE(visits_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_8_14_day,
  --LAST_VALUE(visits_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS visits_past_15_30_day,
  LAST_VALUE(view_items_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_1_day,
  LAST_VALUE(view_items_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_2_day,
  LAST_VALUE(view_items_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_3_day,
  LAST_VALUE(view_items_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_4_day,
  LAST_VALUE(view_items_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_5_day,
  LAST_VALUE(view_items_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_6_day,
  LAST_VALUE(view_items_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_7_day,
  LAST_VALUE(view_items_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_8_14_day,
  --LAST_VALUE(view_items_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS view_items_past_15_30_day,
  LAST_VALUE(add_to_carts_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_1_day,
  LAST_VALUE(add_to_carts_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_2_day,
  LAST_VALUE(add_to_carts_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_3_day,
  LAST_VALUE(add_to_carts_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_4_day,
  LAST_VALUE(add_to_carts_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_5_day,
  LAST_VALUE(add_to_carts_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_6_day,
  LAST_VALUE(add_to_carts_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_7_day,
  LAST_VALUE(add_to_carts_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_8_14_day,
  --LAST_VALUE(add_to_carts_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS add_to_carts_past_15_30_day,
  LAST_VALUE(checkouts_past_1_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_1_day,
  LAST_VALUE(checkouts_past_2_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_2_day,
  LAST_VALUE(checkouts_past_3_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_3_day,
  LAST_VALUE(checkouts_past_4_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_4_day,
  LAST_VALUE(checkouts_past_5_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_5_day,
  LAST_VALUE(checkouts_past_6_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_6_day,
  LAST_VALUE(checkouts_past_7_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_7_day,
  LAST_VALUE(checkouts_past_8_14_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_8_14_day,
  --LAST_VALUE(checkouts_past_15_30_day) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) AS checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  LAST_VALUE(CASE WHEN (
  purchase_day_1+
  purchase_day_2+
  purchase_day_3+
  purchase_day_4+
  purchase_day_5+
  purchase_day_6+
  purchase_day_7) = 0 THEN 0 ELSE 1 END) OVER(PARTITION BY user_pseudo_id, feature_date ORDER BY feature_date DESC) as will_purchase
  FROM `{{project_id}}.{{dataset}}.purchase_propensity_training_full_dataset`
);

CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_purchase_propensity_training_15_15`
(processed_timestamp,
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  --active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  --purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  --visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  --view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  --add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  --checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate
  will_purchase)
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 48 HOUR),
  friendly_name="v_purchase_propensity_training_15_15",
  description="View Purchase Propensity Training dataset using 15 days back to predict 15 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS 
SELECT DISTINCT
  processed_timestamp,
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  --active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  --purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  --visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  --view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  --add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  --checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase
FROM(
SELECT DISTINCT
  processed_timestamp,
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  --active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  --purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  --visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  --view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  --add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  --checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase,
  ROW_NUMBER() OVER (PARTITION BY user_pseudo_id, feature_date, data_split ORDER BY feature_date DESC) AS user_row_order
  FROM `{{project_id}}.{{dataset}}.purchase_propensity_training_15_15`
)
WHERE
  user_row_order = 1;



CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_purchase_propensity_training_15_7`
(
  processed_timestamp,
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  --active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  --purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  --visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  --view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  --add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  --checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase
  )
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 48 HOUR),
  friendly_name="v_purchase_propensity_training_15_7",
  description="View Purchase Propensity Training dataset using 15 days back to predict 7 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS 
SELECT DISTINCT
  processed_timestamp,
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  --active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  --purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  --visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  --view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  --add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  --checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase
FROM(
SELECT DISTINCT
  processed_timestamp,
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  --active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  --purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  --visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  --view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  --add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  --checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase,
  ROW_NUMBER() OVER (PARTITION BY user_pseudo_id, feature_date, data_split ORDER BY feature_date DESC) AS user_row_order
  FROM `{{project_id}}.{{dataset}}.purchase_propensity_training_15_7`
)
WHERE
  user_row_order = 1;


  CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_purchase_propensity_training_30_15`
(processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate
  will_purchase)
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 48 HOUR),
  friendly_name="v_purchase_propensity_training_30_15",
  description="View Purchase Propensity Training dataset using 30 days back to predict 15 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS 
SELECT DISTINCT
  processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase
FROM(
SELECT DISTINCT
  processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase,
  ROW_NUMBER() OVER (PARTITION BY user_pseudo_id, feature_date, data_split ORDER BY feature_date DESC) AS user_row_order
  FROM `{{project_id}}.{{dataset}}.purchase_propensity_training_30_15`
)
WHERE
  user_row_order = 1;

CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_purchase_propensity_training_30_15_last_window`
(processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate
  will_purchase)
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 48 HOUR),
  friendly_name="v_purchase_propensity_training_30_15_last_window",
  description="View Purchase Propensity Training dataset using 30 days back to predict 15 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS 
SELECT DISTINCT
  processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase
FROM(
SELECT DISTINCT
  processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase,
  ROW_NUMBER() OVER (PARTITION BY user_pseudo_id, data_split ORDER BY feature_date DESC) AS user_row_order
  FROM `{{project_id}}.{{dataset}}.purchase_propensity_training_30_15`
)
WHERE
  user_row_order = 1;

  CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_purchase_propensity_training_30_15_balanced`
(processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase)
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 48 HOUR),
  friendly_name="v_purchase_propensity_training_30_15_balanced",
  description="View Purchase Propensity Training dataset using 30 days back to predict 15 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS 
  SELECT DISTINCT
    processed_timestamp,
    data_split,
    --feature_date,
    user_pseudo_id,
    user_id,
    --month_of_the_year,
    --week_of_the_year,
    --day_of_the_month,
    --day_of_week,
    user_ltv_revenue,
    device_category,
    device_mobile_brand_name,
    device_mobile_model_name,
    device_os,
    device_os_version,
    device_language,
    device_web_browser,
    device_web_browser_version,
    geo_sub_continent,
    geo_country,
    geo_region,
    geo_city,
    geo_metro,
    last_traffic_source_medium,
    last_traffic_source_name,
    last_traffic_source_source,
    first_traffic_source_medium,
    first_traffic_source_name,
    first_traffic_source_source,
    has_signed_in_with_user_id,
    --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
    active_users_past_1_day,
    active_users_past_2_day,
    active_users_past_3_day,
    active_users_past_4_day,
    active_users_past_5_day,
    active_users_past_6_day,
    active_users_past_7_day,
    active_users_past_8_14_day,
    active_users_past_15_30_day,
    purchases_past_1_day,
    purchases_past_2_day,
    purchases_past_3_day,
    purchases_past_4_day,
    purchases_past_5_day,
    purchases_past_6_day,
    purchases_past_7_day,
    purchases_past_8_14_day,
    purchases_past_15_30_day,
    visits_past_1_day,
    visits_past_2_day,
    visits_past_3_day,
    visits_past_4_day,
    visits_past_5_day,
    visits_past_6_day,
    visits_past_7_day,
    visits_past_8_14_day,
    visits_past_15_30_day,
    view_items_past_1_day,
    view_items_past_2_day,
    view_items_past_3_day,
    view_items_past_4_day,
    view_items_past_5_day,
    view_items_past_6_day,
    view_items_past_7_day,
    view_items_past_8_14_day,
    view_items_past_15_30_day,
    add_to_carts_past_1_day,
    add_to_carts_past_2_day,
    add_to_carts_past_3_day,
    add_to_carts_past_4_day,
    add_to_carts_past_5_day,
    add_to_carts_past_6_day,
    add_to_carts_past_7_day,
    add_to_carts_past_8_14_day,
    add_to_carts_past_15_30_day,
    checkouts_past_1_day,
    checkouts_past_2_day,
    checkouts_past_3_day,
    checkouts_past_4_day,
    checkouts_past_5_day,
    checkouts_past_6_day,
    checkouts_past_7_day,
    checkouts_past_8_14_day,
    checkouts_past_15_30_day,
    --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
    will_purchase
  FROM (
    SELECT
      DISTINCT *,
      ROW_NUMBER() OVER (PARTITION BY will_purchase ORDER BY RAND()) AS rn
    FROM
      `{{project_id}}.{{dataset}}.v_purchase_propensity_training_30_15` )
  WHERE
    rn <= (
    SELECT
      COUNT(will_purchase)
    FROM
      `{{project_id}}.{{dataset}}.v_purchase_propensity_training_30_15`
    WHERE
      will_purchase = 1) 
;

CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_purchase_propensity_training_30_30`
(processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase)
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 48 HOUR),
  friendly_name="v_purchase_propensity_training_30_30",
  description="View Purchase Propensity Training dataset using 30 days back to predict 15 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS 
SELECT DISTINCT
  processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase
FROM (
SELECT DISTINCT
  processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase,
  ROW_NUMBER() OVER (PARTITION BY user_pseudo_id, feature_date, data_split ORDER BY feature_date DESC) AS user_row_order
  FROM `{{project_id}}.{{dataset}}.purchase_propensity_training_30_30`
)
WHERE
  user_row_order = 1;


  CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_purchase_propensity_training_30_30_balanced`
(processed_timestamp, 
  data_split,
  --feature_date,
  user_pseudo_id,
  user_id,
  --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
  user_ltv_revenue,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
  active_users_past_1_day,
  active_users_past_2_day,
  active_users_past_3_day,
  active_users_past_4_day,
  active_users_past_5_day,
  active_users_past_6_day,
  active_users_past_7_day,
  active_users_past_8_14_day,
  active_users_past_15_30_day,
  purchases_past_1_day,
  purchases_past_2_day,
  purchases_past_3_day,
  purchases_past_4_day,
  purchases_past_5_day,
  purchases_past_6_day,
  purchases_past_7_day,
  purchases_past_8_14_day,
  purchases_past_15_30_day,
  visits_past_1_day,
  visits_past_2_day,
  visits_past_3_day,
  visits_past_4_day,
  visits_past_5_day,
  visits_past_6_day,
  visits_past_7_day,
  visits_past_8_14_day,
  visits_past_15_30_day,
  view_items_past_1_day,
  view_items_past_2_day,
  view_items_past_3_day,
  view_items_past_4_day,
  view_items_past_5_day,
  view_items_past_6_day,
  view_items_past_7_day,
  view_items_past_8_14_day,
  view_items_past_15_30_day,
  add_to_carts_past_1_day,
  add_to_carts_past_2_day,
  add_to_carts_past_3_day,
  add_to_carts_past_4_day,
  add_to_carts_past_5_day,
  add_to_carts_past_6_day,
  add_to_carts_past_7_day,
  add_to_carts_past_8_14_day,
  add_to_carts_past_15_30_day,
  checkouts_past_1_day,
  checkouts_past_2_day,
  checkouts_past_3_day,
  checkouts_past_4_day,
  checkouts_past_5_day,
  checkouts_past_6_day,
  checkouts_past_7_day,
  checkouts_past_8_14_day,
  checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
  will_purchase)
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 48 HOUR),
  friendly_name="v_purchase_propensity_training_30_30_balanced",
  description="View Purchase Propensity Training dataset using 30 days back to predict 15 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS 
  SELECT DISTINCT
    processed_timestamp,
    data_split,
    --feature_date,
    user_pseudo_id,
    user_id,
    --month_of_the_year,
  --week_of_the_year,
  --day_of_the_month,
  --day_of_week,
    user_ltv_revenue,
    device_category,
    device_mobile_brand_name,
    device_mobile_model_name,
    device_os,
    device_os_version,
    device_language,
    device_web_browser,
    device_web_browser_version,
    geo_sub_continent,
    geo_country,
    geo_region,
    geo_city,
    geo_metro,
    last_traffic_source_medium,
    last_traffic_source_name,
    last_traffic_source_source,
    first_traffic_source_medium,
    first_traffic_source_name,
    first_traffic_source_source,
    has_signed_in_with_user_id,
    --engagement_rate,
  --engaged_sessions_per_user,
  --session_conversion_rate,
  --bounces,
  --bounce_rate_per_user,
  --sessions_per_user,
  --avg_views_per_session,
  --sum_engagement_time_seconds,
  --avg_engagement_time_seconds,
  --new_visits,
  --returning_visits,
  --add_to_carts,
  --cart_to_view_rate,
  --checkouts,
  --ecommerce_purchases,
  --ecommerce_quantity,
  --ecommerce_revenue,
  --item_revenue,
  --item_quantity,
  --item_view_events,
  --items_clicked_in_promotion,
  --items_clicked_in_list,
  --items_checked_out,
  --items_added_to_cart,
  --item_list_view_events,
  --purchase_revenue,
  --purchase_to_view_rate,
  --transactions_per_purchaser,
  --user_conversion_rate,
  --how_many_purchased_before,
  --has_abandoned_cart,
    active_users_past_1_day,
    active_users_past_2_day,
    active_users_past_3_day,
    active_users_past_4_day,
    active_users_past_5_day,
    active_users_past_6_day,
    active_users_past_7_day,
    active_users_past_8_14_day,
    active_users_past_15_30_day,
    purchases_past_1_day,
    purchases_past_2_day,
    purchases_past_3_day,
    purchases_past_4_day,
    purchases_past_5_day,
    purchases_past_6_day,
    purchases_past_7_day,
    purchases_past_8_14_day,
    purchases_past_15_30_day,
    visits_past_1_day,
    visits_past_2_day,
    visits_past_3_day,
    visits_past_4_day,
    visits_past_5_day,
    visits_past_6_day,
    visits_past_7_day,
    visits_past_8_14_day,
    visits_past_15_30_day,
    view_items_past_1_day,
    view_items_past_2_day,
    view_items_past_3_day,
    view_items_past_4_day,
    view_items_past_5_day,
    view_items_past_6_day,
    view_items_past_7_day,
    view_items_past_8_14_day,
    view_items_past_15_30_day,
    add_to_carts_past_1_day,
    add_to_carts_past_2_day,
    add_to_carts_past_3_day,
    add_to_carts_past_4_day,
    add_to_carts_past_5_day,
    add_to_carts_past_6_day,
    add_to_carts_past_7_day,
    add_to_carts_past_8_14_day,
    add_to_carts_past_15_30_day,
    checkouts_past_1_day,
    checkouts_past_2_day,
    checkouts_past_3_day,
    checkouts_past_4_day,
    checkouts_past_5_day,
    checkouts_past_6_day,
    checkouts_past_7_day,
    checkouts_past_8_14_day,
    checkouts_past_15_30_day,
  --purchasers_users,
  --average_daily_purchasers,
  --active_users,
  --DAU,
  --MAU,
  --WAU,
  --dau_per_mau,
  --dau_per_wau,
  --wau_per_mau,
  --users_engagement_duration_seconds,
  --average_engagement_time,
  --average_engagement_time_per_session,
  --average_sessions_per_user,
  --ARPPU,
  --ARPU,
  --average_daily_revenue,
  --max_daily_revenue,
  --min_daily_revenue,
  --new_users,
  --returning_users,
  --first_time_purchasers,
  --first_time_purchaser_conversion,
  --first_time_purchasers_per_new_user,
  --avg_user_conversion_rate,
  --avg_session_conversion_rate,
    will_purchase
  FROM (
    SELECT
      DISTINCT *,
      ROW_NUMBER() OVER (PARTITION BY will_purchase ORDER BY RAND()) AS rn
    FROM
      `{{project_id}}.{{dataset}}.v_purchase_propensity_training_30_30` )
  WHERE
    rn <= (
    SELECT
      COUNT(will_purchase)
    FROM
      `{{project_id}}.{{dataset}}.v_purchase_propensity_training_30_30`
    WHERE
      will_purchase = 1) 
;