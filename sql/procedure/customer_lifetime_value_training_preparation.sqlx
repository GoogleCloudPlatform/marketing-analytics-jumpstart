-- Copyright 2023 Google LLC
--
-- Licensed under the Apache License, Version 2.0 (the "License");
-- you may not use this file except in compliance with the License.
-- You may obtain a copy of the License at
--
--     http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing, software
-- distributed under the License is distributed on an "AS IS" BASIS,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-- See the License for the specific language governing permissions and
-- limitations under the License.

DECLARE max_date DATE;
DECLARE min_date DATE;

SET max_date = (SELECT DATE_SUB(MAX(event_date), INTERVAL 180 DAY) FROM `{{mds_project_id}}.{{mds_dataset}}.event`); 
SET min_date = (SELECT DATE_ADD(MIN(event_date), INTERVAL 180 DAY) FROM `{{mds_project_id}}.{{mds_dataset}}.event`); 

CREATE OR REPLACE TEMP TABLE training_preparation_ud as (
  SELECT DISTINCT
    UD.user_pseudo_id,
    MAX(UD.user_id) OVER(user_dimensions_window) AS user_id,
    UD.feature_date,
    MAX(UD.month_of_the_year) OVER(user_dimensions_window) AS month_of_the_year,
    MAX(UD.week_of_the_year) OVER(user_dimensions_window) AS week_of_the_year,
    MAX(UD.day_of_the_month) OVER(user_dimensions_window) AS day_of_the_month,
    MAX(UD.day_of_week) OVER(user_dimensions_window) AS day_of_week,
    MAX(UD.user_ltv_revenue) OVER(user_dimensions_window) AS user_ltv_revenue,
    MAX(UD.device_category) OVER(user_dimensions_window) AS device_category,
    MAX(UD.device_mobile_brand_name) OVER(user_dimensions_window) AS device_mobile_brand_name,
    MAX(UD.device_mobile_model_name) OVER(user_dimensions_window) AS device_mobile_model_name,
    MAX(UD.device_os) OVER(user_dimensions_window) AS device_os,
    MAX(UD.device_os_version) OVER(user_dimensions_window) AS device_os_version,
    MAX(UD.device_language) OVER(user_dimensions_window) AS device_language,
    MAX(UD.device_web_browser) OVER(user_dimensions_window) AS device_web_browser,
    MAX(UD.device_web_browser_version) OVER(user_dimensions_window) AS device_web_browser_version,
    MAX(UD.geo_sub_continent) OVER(user_dimensions_window) AS geo_sub_continent,
    MAX(UD.geo_country) OVER(user_dimensions_window) AS geo_country,
    MAX(UD.geo_region) OVER(user_dimensions_window) AS geo_region,
    MAX(UD.geo_city) OVER(user_dimensions_window) AS geo_city,
    MAX(UD.geo_metro) OVER(user_dimensions_window) AS geo_metro,
    MAX(UD.last_traffic_source_medium) OVER(user_dimensions_window) AS last_traffic_source_medium,
    MAX(UD.last_traffic_source_name) OVER(user_dimensions_window) AS last_traffic_source_name,
    MAX(UD.last_traffic_source_source) OVER(user_dimensions_window) AS last_traffic_source_source,
    MAX(UD.first_traffic_source_medium) OVER(user_dimensions_window) AS first_traffic_source_medium,
    MAX(UD.first_traffic_source_name) OVER(user_dimensions_window) AS first_traffic_source_name,
    MAX(UD.first_traffic_source_source) OVER(user_dimensions_window) AS first_traffic_source_source,
    MAX(UD.has_signed_in_with_user_id) OVER(user_dimensions_window) AS has_signed_in_with_user_id,
FROM
  `{{feature_store_project_id}}.{{feature_store_dataset}}.user_lifetime_dimensions` UD
WHERE
  -- In the future consider `feature_date BETWEEN start_date AND end_date`, to process multiple days. Modify Partition BY
  UD.feature_date BETWEEN GREATEST(start_date, min_date) AND LEAST(end_date, max_date)
WINDOW 
  user_dimensions_window AS (PARTITION BY UD.user_pseudo_id, UD.feature_date ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
);

CREATE OR REPLACE TEMP TABLE training_preparation_uwm as (
  SELECT DISTINCT
    UWM.user_pseudo_id,
    UWM.feature_date,
    MAX(UWM.active_users_past_1_30_day) OVER(user_rolling_window) AS active_users_past_1_30_day,
    MAX(UWM.active_users_past_30_60_day) OVER(user_rolling_window) AS active_users_past_30_60_day,
    MAX(UWM.active_users_past_60_90_day) OVER(user_rolling_window) AS active_users_past_60_90_day,
    MAX(UWM.active_users_past_90_120_day) OVER(user_rolling_window) AS active_users_past_90_120_day,
    MAX(UWM.active_users_past_120_150_day) OVER(user_rolling_window) AS active_users_past_120_150_day,
    MAX(UWM.active_users_past_150_180_day) OVER(user_rolling_window) AS active_users_past_150_180_day,
    MAX(UWM.purchases_past_1_30_day) OVER(user_rolling_window) AS purchases_past_1_30_day,
    MAX(UWM.purchases_past_30_60_day) OVER(user_rolling_window) AS purchases_past_30_60_day,
    MAX(UWM.purchases_past_60_90_day) OVER(user_rolling_window) AS purchases_past_60_90_day,
    MAX(UWM.purchases_past_90_120_day) OVER(user_rolling_window) AS purchases_past_90_120_day,
    MAX(UWM.purchases_past_120_150_day) OVER(user_rolling_window) AS purchases_past_120_150_day,
    MAX(UWM.purchases_past_150_180_day) OVER(user_rolling_window) AS purchases_past_150_180_day,
    MAX(UWM.visits_past_1_30_day) OVER(user_rolling_window) AS visits_past_1_30_day,
    MAX(UWM.visits_past_30_60_day) OVER(user_rolling_window) AS visits_past_30_60_day,
    MAX(UWM.visits_past_60_90_day) OVER(user_rolling_window) AS visits_past_60_90_day,
    MAX(UWM.visits_past_90_120_day) OVER(user_rolling_window) AS visits_past_90_120_day,
    MAX(UWM.visits_past_120_150_day) OVER(user_rolling_window) AS visits_past_120_150_day,
    MAX(UWM.visits_past_150_180_day) OVER(user_rolling_window) AS visits_past_150_180_day,
    MAX(UWM.view_items_past_1_30_day) OVER(user_rolling_window) AS view_items_past_1_30_day,
    MAX(UWM.view_items_past_30_60_day) OVER(user_rolling_window) AS view_items_past_30_60_day,
    MAX(UWM.view_items_past_60_90_day) OVER(user_rolling_window) AS view_items_past_60_90_day,
    MAX(UWM.view_items_past_90_120_day) OVER(user_rolling_window) AS view_items_past_90_120_day,
    MAX(UWM.view_items_past_120_150_day) OVER(user_rolling_window) AS view_items_past_120_150_day,
    MAX(UWM.view_items_past_150_180_day) OVER(user_rolling_window) AS view_items_past_150_180_day,
    MAX(UWM.add_to_carts_past_1_30_day) OVER(user_rolling_window) AS add_to_carts_past_1_30_day,
    MAX(UWM.add_to_carts_past_30_60_day) OVER(user_rolling_window) AS add_to_carts_past_30_60_day,
    MAX(UWM.add_to_carts_past_60_90_day) OVER(user_rolling_window) AS add_to_carts_past_60_90_day,
    MAX(UWM.add_to_carts_past_90_120_day) OVER(user_rolling_window) AS add_to_carts_past_90_120_day,
    MAX(UWM.add_to_carts_past_120_150_day) OVER(user_rolling_window) AS add_to_carts_past_120_150_day,
    MAX(UWM.add_to_carts_past_150_180_day) OVER(user_rolling_window) AS add_to_carts_past_150_180_day,
    MAX(UWM.checkouts_past_1_30_day) OVER(user_rolling_window) AS checkouts_past_1_30_day,
    MAX(UWM.checkouts_past_30_60_day) OVER(user_rolling_window) AS checkouts_past_30_60_day,
    MAX(UWM.checkouts_past_60_90_day) OVER(user_rolling_window) AS checkouts_past_60_90_day,
    MAX(UWM.checkouts_past_90_120_day) OVER(user_rolling_window) AS checkouts_past_90_120_day,
    MAX(UWM.checkouts_past_120_150_day) OVER(user_rolling_window) AS checkouts_past_120_150_day,
    MAX(UWM.checkouts_past_150_180_day) OVER(user_rolling_window) AS checkouts_past_150_180_day,
    --MAX(UWM.ltv_revenue_past_1_30_day) OVER(user_rolling_window) AS ltv_revenue_past_1_30_day,
    --MAX(UWM.ltv_revenue_past_30_90_day) OVER(user_rolling_window) AS ltv_revenue_past_30_90_day,
    --MAX(UWM.ltv_revenue_past_90_180_day) OVER(user_rolling_window) AS ltv_revenue_past_90_180_day,
FROM
  `{{feature_store_project_id}}.{{feature_store_dataset}}.user_rolling_window_lifetime_metrics` UWM
WHERE
  -- In the future consider `feature_date BETWEEN start_date AND end_date`, to process multiple days. Modify Partition BY
  UWM.feature_date BETWEEN GREATEST(start_date, min_date) AND LEAST(end_date, max_date)
WINDOW 
  user_rolling_window AS (PARTITION BY UWM.user_pseudo_id, UWM.feature_date ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
);

CREATE OR REPLACE TEMP TABLE training_preparation_um as (
  SELECT DISTINCT
    UM.feature_date,
    MAX(UM.lifetime_purchasers_users) OVER(user_scoped_metrics_window) AS lifetime_purchasers_users,
    MAX(UM.lifetime_average_daily_purchasers) OVER(user_scoped_metrics_window) AS lifetime_average_daily_purchasers,
    MAX(UM.lifetime_active_users) OVER(user_scoped_metrics_window) AS lifetime_active_users,
    MAX(UM.lifetime_DAU) OVER(user_scoped_metrics_window) AS lifetime_DAU,
    MAX(UM.lifetime_MAU) OVER(user_scoped_metrics_window) AS lifetime_MAU,
    MAX(UM.lifetime_WAU) OVER(user_scoped_metrics_window) AS lifetime_WAU,
    MAX(UM.lifetime_dau_per_mau) OVER(user_scoped_metrics_window) AS lifetime_dau_per_mau,
    MAX(UM.lifetime_dau_per_wau) OVER(user_scoped_metrics_window) AS lifetime_dau_per_wau,
    MAX(UM.lifetime_wau_per_mau) OVER(user_scoped_metrics_window) AS lifetime_wau_per_mau,
    MAX(UM.lifetime_users_engagement_duration_seconds) OVER(user_scoped_metrics_window) AS lifetime_users_engagement_duration_seconds,
    MAX(UM.lifetime_average_engagement_time) OVER(user_scoped_metrics_window) AS lifetime_average_engagement_time,
    MAX(UM.lifetime_average_engagement_time_per_session) OVER(user_scoped_metrics_window) AS lifetime_average_engagement_time_per_session,
    MAX(UM.lifetime_average_sessions_per_user) OVER(user_scoped_metrics_window) AS lifetime_average_sessions_per_user,
    MAX(UM.lifetime_ARPPU) OVER(user_scoped_metrics_window) AS lifetime_ARPPU,
    MAX(UM.lifetime_ARPU) OVER(user_scoped_metrics_window) AS lifetime_ARPU,
    MAX(UM.lifetime_average_daily_revenue) OVER(user_scoped_metrics_window) AS lifetime_average_daily_revenue,
    MAX(UM.lifetime_max_daily_revenue) OVER(user_scoped_metrics_window) AS lifetime_max_daily_revenue,
    MAX(UM.lifetime_min_daily_revenue) OVER(user_scoped_metrics_window) AS lifetime_min_daily_revenue,
    MAX(UM.lifetime_new_users) OVER(user_scoped_metrics_window) AS lifetime_new_users,
    MAX(UM.lifetime_returning_users) OVER(user_scoped_metrics_window) AS lifetime_returning_users,
    MAX(UM.lifetime_first_time_purchasers) OVER(user_scoped_metrics_window) AS lifetime_first_time_purchasers,
    MAX(UM.lifetime_first_time_purchaser_conversion) OVER(user_scoped_metrics_window) AS lifetime_first_time_purchaser_conversion,
    MAX(UM.lifetime_first_time_purchasers_per_new_user) OVER(user_scoped_metrics_window) AS lifetime_first_time_purchasers_per_new_user,
    MAX(UM.lifetime_avg_user_conversion_rate) OVER(user_scoped_metrics_window) AS lifetime_avg_user_conversion_rate,
    MAX(UM.lifetime_avg_session_conversion_rate) OVER(user_scoped_metrics_window) AS lifetime_avg_session_conversion_rate,
FROM
  `{{feature_store_project_id}}.{{feature_store_dataset}}.user_scoped_lifetime_metrics` UM
WHERE
  -- In the future consider `feature_date BETWEEN start_date AND end_date`, to process multiple days.
  UM.feature_date BETWEEN GREATEST(start_date, min_date) AND LEAST(end_date, max_date)
WINDOW 
  user_scoped_metrics_window AS (PARTITION BY UM.feature_date ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
);

CREATE OR REPLACE TEMP TABLE training_preparation_label as (
  SELECT DISTINCT
    LABEL.user_pseudo_id,
    LABEL.feature_date,
    MAX(LABEL.pltv_revenue_30_days) OVER(customer_lifetime_value_window) AS pltv_revenue_30_days,
    MAX(LABEL.pltv_revenue_90_days) OVER(customer_lifetime_value_window) AS pltv_revenue_90_days,
    MAX(LABEL.pltv_revenue_180_days) OVER(customer_lifetime_value_window) AS pltv_revenue_180_days
FROM
  `{{feature_store_project_id}}.{{feature_store_dataset}}.customer_lifetime_value_label` LABEL
WHERE
  -- Define the training subset interval
  LABEL.feature_date BETWEEN GREATEST(start_date, min_date) AND LEAST(end_date, max_date)
WINDOW 
  customer_lifetime_value_window AS (PARTITION BY LABEL.user_pseudo_id, LABEL.feature_date ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
);

CREATE OR REPLACE TEMP TABLE training_preparation as (
  SELECT DISTINCT
    UD.user_pseudo_id,
    UD.user_id,
    UD.feature_date,
    UD.month_of_the_year,
    UD.week_of_the_year,
    UD.day_of_the_month,
    UD.day_of_week,
    UD.device_category,
    UD.device_mobile_brand_name,
    UD.device_mobile_model_name,
    UD.device_os,
    UD.device_os_version,
    UD.device_language,
    UD.device_web_browser,
    UD.device_web_browser_version,
    UD.geo_sub_continent,
    UD.geo_country,
    UD.geo_region,
    UD.geo_city,
    UD.geo_metro,
    UD.last_traffic_source_medium,
    UD.last_traffic_source_name,
    UD.last_traffic_source_source,
    UD.first_traffic_source_medium,
    UD.first_traffic_source_name,
    UD.first_traffic_source_source,
    UD.has_signed_in_with_user_id,
    UWM.active_users_past_1_30_day,
    UWM.active_users_past_30_60_day,
    UWM.active_users_past_60_90_day,
    UWM.active_users_past_90_120_day,
    UWM.active_users_past_120_150_day,
    UWM.active_users_past_150_180_day,
    UWM.purchases_past_1_30_day,
    UWM.purchases_past_30_60_day,
    UWM.purchases_past_60_90_day,
    UWM.purchases_past_90_120_day,
    UWM.purchases_past_120_150_day,
    UWM.purchases_past_150_180_day,
    UWM.visits_past_1_30_day,
    UWM.visits_past_30_60_day,
    UWM.visits_past_60_90_day,
    UWM.visits_past_90_120_day,
    UWM.visits_past_120_150_day,
    UWM.visits_past_150_180_day,
    UWM.view_items_past_1_30_day,
    UWM.view_items_past_30_60_day,
    UWM.view_items_past_60_90_day,
    UWM.view_items_past_90_120_day,
    UWM.view_items_past_120_150_day,
    UWM.view_items_past_150_180_day,
    UWM.add_to_carts_past_1_30_day,
    UWM.add_to_carts_past_30_60_day,
    UWM.add_to_carts_past_60_90_day,
    UWM.add_to_carts_past_90_120_day,
    UWM.add_to_carts_past_120_150_day,
    UWM.add_to_carts_past_150_180_day,
    UWM.checkouts_past_1_30_day,
    UWM.checkouts_past_30_60_day,
    UWM.checkouts_past_60_90_day,
    UWM.checkouts_past_90_120_day,
    UWM.checkouts_past_120_150_day,
    UWM.checkouts_past_150_180_day,
    --UWM.ltv_revenue_past_1_30_day,
    --UWM.ltv_revenue_past_30_90_day,
    --UWM.ltv_revenue_past_90_180_day,
    UM.lifetime_purchasers_users,
    UM.lifetime_average_daily_purchasers,
    UM.lifetime_active_users,
    UM.lifetime_DAU,
    UM.lifetime_MAU,
    UM.lifetime_WAU,
    UM.lifetime_dau_per_mau,
    UM.lifetime_dau_per_wau,
    UM.lifetime_wau_per_mau,
    UM.lifetime_users_engagement_duration_seconds,
    UM.lifetime_average_engagement_time,
    UM.lifetime_average_engagement_time_per_session,
    UM.lifetime_average_sessions_per_user,
    UM.lifetime_ARPPU,
    UM.lifetime_ARPU,
    UM.lifetime_average_daily_revenue,
    UM.lifetime_max_daily_revenue,
    UM.lifetime_min_daily_revenue,
    UM.lifetime_new_users,
    UM.lifetime_returning_users,
    UM.lifetime_first_time_purchasers,
    UM.lifetime_first_time_purchaser_conversion,
    UM.lifetime_first_time_purchasers_per_new_user,
    UM.lifetime_avg_user_conversion_rate,
    UM.lifetime_avg_session_conversion_rate,
    LABEL.pltv_revenue_30_days,
    LABEL.pltv_revenue_90_days,
    LABEL.pltv_revenue_180_days
FROM
  training_preparation_ud UD
INNER JOIN
  training_preparation_uwm UWM
ON
  UWM.user_pseudo_id = UD.user_pseudo_id
  AND UWM.feature_date = UD.feature_date
INNER JOIN
  training_preparation_um UM
ON
  UM.feature_date = UD.feature_date
INNER JOIN
  training_preparation_label LABEL
ON
  LABEL.user_pseudo_id = UD.user_pseudo_id
  AND LABEL.feature_date = UD.feature_date
);


CREATE OR REPLACE TEMP TABLE DataForTargetTable AS(
  SELECT DISTINCT
  CASE 
    WHEN (ABS(MOD(FARM_FINGERPRINT(user_pseudo_id), 10)) BETWEEN 0 AND train_split_end_number) THEN "TRAIN" 
    WHEN (ABS(MOD(FARM_FINGERPRINT(user_pseudo_id), 10)) BETWEEN train_split_end_number AND validation_split_end_number) THEN "VALIDATE" 
    WHEN (ABS(MOD(FARM_FINGERPRINT(user_pseudo_id), 10)) BETWEEN validation_split_end_number AND 9) THEN "TEST"
  END as data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  --ltv_revenue_past_1_30_day,
  --ltv_revenue_past_30_90_day,
  --ltv_revenue_past_90_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_30_days,
  pltv_revenue_90_days,
  pltv_revenue_180_days
  FROM training_preparation);

CREATE OR REPLACE TABLE `{{project_id}}.{{dataset}}.{{insert_table}}` AS
SELECT DISTINCT * FROM DataForTargetTable
WHERE data_split IS NOT NULL;


CREATE OR REPLACE TABLE `{{project_id}}.{{dataset}}.customer_lifetime_value_training_180_30` AS(
  SELECT DISTINCT
  CURRENT_TIMESTAMP() AS processed_timestamp, 
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_30_days
  FROM `{{project_id}}.{{dataset}}.{{insert_table}}`
);

CREATE OR REPLACE TABLE `{{project_id}}.{{dataset}}.customer_lifetime_value_training_180_90` AS(
  SELECT 
  CURRENT_TIMESTAMP() AS processed_timestamp,
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_90_days
  FROM `{{project_id}}.{{dataset}}.{{insert_table}}`
);

CREATE OR REPLACE TABLE `{{project_id}}.{{dataset}}.customer_lifetime_value_training_180_180` AS(
  SELECT 
  CURRENT_TIMESTAMP() AS processed_timestamp,
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_180_days
  FROM `{{project_id}}.{{dataset}}.{{insert_table}}`
);

CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_customer_lifetime_value_training_180_30`
(processed_timestamp,
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_30_days)
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL {{expiration_duration_hours}} HOUR),
  friendly_name="v_customer_lifetime_value_training_180_30",
  description="View Purchase Propensity Training dataset using 15 days back to predict 15 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS 
SELECT DISTINCT
  processed_timestamp,
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_30_days
  FROM `{{project_id}}.{{dataset}}.customer_lifetime_value_training_180_30`;



CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_customer_lifetime_value_training_180_90`
(
  processed_timestamp,
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_90_days)
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL {{expiration_duration_hours}} HOUR),
  friendly_name="v_customer_lifetime_value_training_180_90",
  description="View Purchase Propensity Training dataset using 15 days back to predict 7 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS 
SELECT DISTINCT
  processed_timestamp,
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_90_days
  FROM `{{project_id}}.{{dataset}}.customer_lifetime_value_training_180_90`;


  CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_customer_lifetime_value_training_180_180`
(processed_timestamp, 
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_180_days)
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL {{expiration_duration_hours}} HOUR),
  friendly_name="v_customer_lifetime_value_training_180_180",
  description="View Purchase Propensity Training dataset using 30 days back to predict 15 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS 
SELECT DISTINCT
  processed_timestamp, 
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_180_days
  FROM `{{project_id}}.{{dataset}}.customer_lifetime_value_training_180_180`;




CREATE OR REPLACE VIEW `{{project_id}}.{{dataset}}.v_customer_lifetime_value_training_180_30_balanced`
(processed_timestamp,
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_30_days)
OPTIONS(
  --expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL {{expiration_duration_hours}} HOUR),
  friendly_name="v_customer_lifetime_value_training_180_30_balanced",
  description="View Purchase Propensity Training dataset using 15 days back to predict 15 days ahead. View expires after 48h and should run daily.",
  labels=[("org_unit", "development")]
) AS
SELECT 
  processed_timestamp,
  data_split,
  feature_date,
  user_pseudo_id,
  user_id,
  month_of_the_year,
  week_of_the_year,
  day_of_the_month,
  day_of_week,
  device_category,
  device_mobile_brand_name,
  device_mobile_model_name,
  device_os,
  device_os_version,
  device_language,
  device_web_browser,
  device_web_browser_version,
  geo_sub_continent,
  geo_country,
  geo_region,
  geo_city,
  geo_metro,
  last_traffic_source_medium,
  last_traffic_source_name,
  last_traffic_source_source,
  first_traffic_source_medium,
  first_traffic_source_name,
  first_traffic_source_source,
  has_signed_in_with_user_id,
  active_users_past_1_30_day,
  active_users_past_30_60_day,
  active_users_past_60_90_day,
  active_users_past_90_120_day,
  active_users_past_120_150_day,
  active_users_past_150_180_day,
  purchases_past_1_30_day,
  purchases_past_30_60_day,
  purchases_past_60_90_day,
  purchases_past_90_120_day,
  purchases_past_120_150_day,
  purchases_past_150_180_day,
  visits_past_1_30_day,
  visits_past_30_60_day,
  visits_past_60_90_day,
  visits_past_90_120_day,
  visits_past_120_150_day,
  visits_past_150_180_day,
  view_items_past_1_30_day,
  view_items_past_30_60_day,
  view_items_past_60_90_day,
  view_items_past_90_120_day,
  view_items_past_120_150_day,
  view_items_past_150_180_day,
  add_to_carts_past_1_30_day,
  add_to_carts_past_30_60_day,
  add_to_carts_past_60_90_day,
  add_to_carts_past_90_120_day,
  add_to_carts_past_120_150_day,
  add_to_carts_past_150_180_day,
  checkouts_past_1_30_day,
  checkouts_past_30_60_day,
  checkouts_past_60_90_day,
  checkouts_past_90_120_day,
  checkouts_past_120_150_day,
  checkouts_past_150_180_day,
  lifetime_purchasers_users,
  lifetime_average_daily_purchasers,
  lifetime_active_users,
  lifetime_DAU,
  lifetime_MAU,
  lifetime_WAU,
  lifetime_dau_per_mau,
  lifetime_dau_per_wau,
  lifetime_wau_per_mau,
  lifetime_users_engagement_duration_seconds,
  lifetime_average_engagement_time,
  lifetime_average_engagement_time_per_session,
  lifetime_average_sessions_per_user,
  lifetime_ARPPU,
  lifetime_ARPU,
  lifetime_average_daily_revenue,
  lifetime_max_daily_revenue,
  lifetime_min_daily_revenue,
  lifetime_new_users,
  lifetime_returning_users,
  lifetime_first_time_purchasers,
  lifetime_first_time_purchaser_conversion,
  lifetime_first_time_purchasers_per_new_user,
  lifetime_avg_user_conversion_rate,
  lifetime_avg_session_conversion_rate,
  pltv_revenue_30_days
FROM
(
SELECT
* EXCEPT(rn) FROM (
SELECT
  *,
  ROW_NUMBER() OVER (PARTITION BY bucket ORDER BY RAND()) AS rn
FROM (
  SELECT
    *,
    CASE
      WHEN pltv_revenue_30_days < 50 THEN "bucket1"
      WHEN pltv_revenue_30_days BETWEEN 50 AND 100 THEN "bucket2"
      WHEN pltv_revenue_30_days BETWEEN 100 AND 200 THEN "bucket3"
      WHEN pltv_revenue_30_days BETWEEN 200 AND 300 THEN "bucket4"
      WHEN pltv_revenue_30_days BETWEEN 300 AND 400 THEN "bucket5"
      WHEN pltv_revenue_30_days BETWEEN 400 AND 500 THEN "bucket6" 
      WHEN pltv_revenue_30_days BETWEEN 500 AND 750 THEN "bucket7" 
      WHEN pltv_revenue_30_days BETWEEN 750 AND 1000 THEN "bucket8" 
      WHEN pltv_revenue_30_days BETWEEN 1000 AND 2000 THEN "bucket9" 
      WHEN pltv_revenue_30_days > 2000 THEN "bucket10" END as bucket
  FROM
    `{{project_id}}.{{dataset}}.v_customer_lifetime_value_training_180_30`)
)
WHERE
    rn <= 10000)
;



DROP TABLE training_preparation;
DROP TABLE DataForTargetTable;
